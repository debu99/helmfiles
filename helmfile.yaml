repositories:
  - name: stable
    url: https://charts.helm.sh/stable
  - name: bitnami
    url: https://charts.bitnami.com/bitnami
  - name: external-secrets
    url: https://charts.external-secrets.io
  - name: grafana
    url: https://grafana.github.io/helm-charts

releases:
  - name: external-secrets
    chart: external-secrets/external-secrets
    version: 0.5.3
    namespace: external-secrets
    createNamespace: true
    wait: true
    hooks:
      - events: ["cleanup"]
        showlogs: true
        command: "kubectl"
        args: ["wait", "--for", "condition=established", "--timeout=60s", "crd/externalsecrets.external-secrets.io"]
  - name: secrets
    chart: ./secrets/externalsecrets/
    values:
      - namespace: external-secrets
        aws_region: us-east-1
        aws_access_key: {{ requiredEnv "AWS_ACCESS_KEY" }}
        aws_secret_key: {{ requiredEnv "AWS_SECRET_KEY" }}
    wait: true
  - name: mysql
    chart: bitnami/mysql
    version: 9.0.4
    namespace: db
    createNamespace: true
    values:
      - auth:
          username: "app_user"
          existingSecret: mysql-secret
          database: grafana
  - name: grafana
    chart: grafana/grafana
    version: 6.29.4
    namespace: monitoring
    createNamespace: true
    values:
      - admin:
          existingSecret: "grafana-secret"
          userKey: "admin_username"
          passwordKey: "admin_password"
        grafana.ini:
          database:
            type: mysql
            host: mysql.db
            name: grafana
        envValueFrom:
          GF_DATABASE_USER:
            secretKeyRef:
              name: grafana-secret
              key: db_username
          GF_DATABASE_PASSWORD:
            secretKeyRef:
              name: grafana-secret
              key: db_password
